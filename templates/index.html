
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrismTrade - Анализ акций и прогнозирование</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            font-weight: 600;
        }
        .recommendations {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .buy {
            background-color: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
        }
        .sell {
            background-color: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
        }
        .prediction-chart {
            border-radius: 10px;
            max-width: 100%;
            height: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .indicator {
            margin-bottom: 5px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .badge-success {
            background-color: #28a745;
            color: white;
        }
        .badge-danger {
            background-color: #dc3545;
            color: white;
        }
        .badge-warning {
            background-color: #ffc107;
            color: black;
        }
        .badge-info {
            background-color: #17a2b8;
            color: white;
        }
        .price-change-positive {
            color: #28a745;
        }
        .price-change-negative {
            color: #dc3545;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .form-label {
            font-weight: 600;
        }
        #analysisResults, #loadingIndicator, #errorMessage {
            display: none;
        }
        .meta-learning-badge {
            background-color: #9c27b0;
            color: white;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }
        .toggle-details {
            cursor: pointer;
            color: #0d6efd;
            font-size: 0.9rem;
        }
        .weight-progress {
            height: 20px;
            position: relative;
            background: #f5f5f5;
            border-radius: 5px;
            overflow: hidden;
        }
        .weight-bar {
            height: 100%;
            background: linear-gradient(90deg, rgba(41,128,185,1) 0%, rgba(52,152,219,1) 100%);
            border-radius: 5px;
        }
        .weight-text {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            line-height: 20px;
            text-align: center;
            color: white;
            mix-blend-mode: difference;
            font-weight: bold;
            font-size: 0.85rem;
        }
        .confidence-meter {
            height: 25px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .confidence-bar {
            height: 100%;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container py-4" id="app">
        <div class="row">
            <div class="col-lg-8 offset-lg-2">
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white text-center">
                        <h2 class="mb-0">PrismTrade - Анализ акций</h2>
                    </div>
                    <div class="card-body">
                        <form id="analysisForm" class="mb-4">
                            <div class="mb-3">
                                <label for="tickerInput" class="form-label">Введите тикер акции (Мосбиржа)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="tickerInput" name="ticker" placeholder="Например: SBER" required>
                                    <button class="btn btn-primary" type="submit">Анализировать</button>
                                </div>
                                <div class="form-text">Например: SBER, GAZP, LKOH, YNDX, AFLT</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="useMetaLearning" name="use_meta_learning">
                                <label class="form-check-label" for="useMetaLearning">
                                    Использовать метаобучение для корректировки прогнозов
                                </label>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="loadingIndicator">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="loader"></div>
                            <p class="mt-3">Загрузка данных и анализ акции...</p>
                        </div>
                    </div>
                </div>

                <div id="errorMessage" class="alert alert-danger" role="alert"></div>

                <div id="analysisResults">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h4 class="mb-0" id="resultTitle">Анализ акции: <span id="tickerName"></span></h4>
                            <div>
                                <button id="update-data-btn" class="btn btn-outline-light btn-sm ms-2">Автообновление</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="fs-4">Текущая цена: <span id="currentPrice" class="fw-bold"></span> ₽</p>
                                    <p>Изменение: <span id="priceChange"></span></p>
                                    <p>Волатильность: <span id="volatility"></span>%</p>
                                    <p>Моментум: <span id="momentum"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p>RSI: <span id="rsi"></span></p>
                                    <p>MACD: <span id="macd"></span></p>
                                    <p>Сигнальная линия: <span id="signalLine"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Рыночное состояние</h5>
                        </div>
                        <div class="card-body">
                            <div id="marketStateInfo"></div>
                        </div>
                    </div>

                    <div id="recommendationCard" class="card mb-4">
                        <div class="card-header text-white">
                            <h5 class="mb-0">Рекомендация</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <h4 id="recommendationText" class="mb-0 me-3"></h4>
                                <div class="ms-auto">
                                    <div class="confidence-meter" style="width: 150px;">
                                        <div id="confidenceBar" class="confidence-bar"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <a class="toggle-details" data-bs-toggle="collapse" href="#reasonsCollapse" role="button" aria-expanded="false">
                                    Показать факторы анализа <i class="fas fa-chevron-down"></i>
                                </a>
                                <div class="collapse mt-2" id="reasonsCollapse">
                                    <div id="reasonsList" class="list-group"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            Параметры входа в LONG
                                        </div>
                                        <div class="card-body">
                                            <p>Цена входа: <span id="entryPriceBuy" class="fw-bold"></span> ₽</p>
                                            <p>Цена выхода: <span id="exitPriceBuy" class="fw-bold"></span> ₽</p>
                                            <p>Стоп-лосс: <span id="stopLossBuy" class="fw-bold"></span> ₽</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-danger text-white">
                                            Параметры входа в SHORT
                                        </div>
                                        <div class="card-body">
                                            <p>Цена входа: <span id="entryPriceSell" class="fw-bold"></span> ₽</p>
                                            <p>Цена выхода: <span id="exitPriceSell" class="fw-bold"></span> ₽</p>
                                            <p>Стоп-лосс: <span id="stopLossSell" class="fw-bold"></span> ₽</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Прогноз цены</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            15 минут
                                        </div>
                                        <div class="card-body text-center">
                                            <h4 id="prediction15" class="mb-1"></h4>
                                            <p id="change15" class="mb-0"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            30 минут
                                        </div>
                                        <div class="card-body text-center">
                                            <h4 id="prediction30" class="mb-1"></h4>
                                            <p id="change30" class="mb-0"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            60 минут
                                        </div>
                                        <div class="card-body text-center">
                                            <h4 id="prediction60" class="mb-1"></h4>
                                            <p id="change60" class="mb-0"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="metaLearningSection" style="display: none;">
                                <div class="alert alert-primary d-flex align-items-center" role="alert">
                                    <i class="fas fa-robot me-2"></i>
                                    <div>
                                        Применено метаобучение для корректировки прогнозов на основе исторической точности.
                                        <a class="toggle-details" data-bs-toggle="collapse" href="#metaDetailsCollapse" role="button" aria-expanded="false">
                                            Подробнее <i class="fas fa-chevron-down"></i>
                                        </a>
                                    </div>
                                </div>
                                <div class="collapse" id="metaDetailsCollapse">
                                    <div class="card card-body mb-3">
                                        <div id="metaLearningDetails"></div>
                                        <div id="metaLearningChart" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <img id="predictionChart" class="img-fluid prediction-chart w-100" alt="График прогноза">
                            </div>
                        </div>
                    </div>

                    <!-- Секция для отображения информации о динамическом взвешивании ансамбля -->
                    <div id="ensembleWeightsSection" class="card mb-4" style="display: none;">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Динамическое взвешивание ансамбля</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h6>Оптимальные веса моделей в ансамбле:</h6>
                                <div id="weightsContainer" class="row"></div>
                            </div>
                            <div id="ensembleChart" class="mt-4"></div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                Анализ точности предыдущих прогнозов
                                <button id="accuracyBtn" class="btn btn-outline-light btn-sm float-end">Показать</button>
                            </h5>
                        </div>
                        <div class="card-body" id="accuracySection" style="display: none;">
                            <div id="accuracyLoading" class="text-center">
                                <div class="loader"></div>
                                <p>Загрузка данных о точности...</p>
                            </div>
                            <div id="accuracyContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-lg-8 offset-lg-2">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Расширенная аналитика</h5>
                    </div>
                    <div class="card-body">
                        <p>Доступно для анализируемой акции:</p>
                        <button id="advancedAnalyticsBtn" class="btn btn-primary">Расширенный анализ</button>
                        <div id="advancedAnalyticsSection" class="mt-3" style="display: none;">
                            <div id="advancedLoading" class="text-center">
                                <div class="loader"></div>
                                <p>Выполнение расширенного анализа...</p>
                            </div>
                            <div id="advancedContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let autoUpdateInterval = null;
        let currentTicker = '';

        document.getElementById('analysisForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            const useMetaLearning = document.getElementById('useMetaLearning').checked;
            
            if (ticker) {
                currentTicker = ticker;
                analyzeStock(ticker, useMetaLearning);
            }
        });

        function analyzeStock(ticker, useMetaLearning = false) {
            document.getElementById('analysisResults').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'block';
            
            const formData = new FormData();
            formData.append('ticker', ticker);
            formData.append('use_meta_learning', useMetaLearning);
            
            fetch('/analyze', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingIndicator').style.display = 'none';
                
                if (data.error) {
                    document.getElementById('errorMessage').textContent = data.error;
                    document.getElementById('errorMessage').style.display = 'block';
                    return;
                }
                
                displayResults(data);
                document.getElementById('analysisResults').style.display = 'block';
            })
            .catch(error => {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorMessage').textContent = 'Произошла ошибка при анализе: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
            });
        }

        function displayResults(data) {
            document.getElementById('tickerName').textContent = data.ticker;
            document.getElementById('currentPrice').textContent = data.current_price.toFixed(2);
            
            const priceChangeEl = document.getElementById('priceChange');
            const priceChangeText = data.price_change.toFixed(2) + '%';
            if (data.price_change >= 0) {
                priceChangeEl.innerHTML = `<span class="price-change-positive">+${priceChangeText} <i class="fas fa-arrow-up"></i></span>`;
            } else {
                priceChangeEl.innerHTML = `<span class="price-change-negative">${priceChangeText} <i class="fas fa-arrow-down"></i></span>`;
            }
            
            document.getElementById('volatility').textContent = data.volatility.toFixed(2);
            
            const momentumEl = document.getElementById('momentum');
            const momentumText = data.momentum.toFixed(2);
            if (data.momentum >= 0) {
                momentumEl.innerHTML = `<span class="price-change-positive">+${momentumText} <i class="fas fa-arrow-up"></i></span>`;
            } else {
                momentumEl.innerHTML = `<span class="price-change-negative">${momentumText} <i class="fas fa-arrow-down"></i></span>`;
            }
            
            document.getElementById('rsi').textContent = data.rsi.toFixed(2);
            document.getElementById('macd').textContent = data.macd.toFixed(4);
            document.getElementById('signalLine').textContent = data.signal_line.toFixed(4);
            
            // Отображение состояния рынка
            const marketStateElement = document.getElementById('marketStateInfo');
            marketStateElement.innerHTML = '';
            
            if (data.market_state && data.market_state.explanation) {
                const stateList = document.createElement('ul');
                stateList.className = 'list-group list-group-flush';
                
                data.market_state.explanation.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';
                    listItem.innerHTML = item;
                    stateList.appendChild(listItem);
                });
                
                marketStateElement.appendChild(stateList);
                
                if (data.market_state.bullish) {
                    marketStateElement.innerHTML = `<div class="alert alert-success mb-3">
                        <i class="fas fa-chart-line me-2"></i> <strong>Бычий тренд</strong> (сила: ${data.market_state.trend_strength}%)
                    </div>` + marketStateElement.innerHTML;
                } else if (data.market_state.bearish) {
                    marketStateElement.innerHTML = `<div class="alert alert-danger mb-3">
                        <i class="fas fa-chart-line me-2"></i> <strong>Медвежий тренд</strong> (сила: ${data.market_state.trend_strength}%)
                    </div>` + marketStateElement.innerHTML;
                }
            }
            
            // Настройка рекомендации
            const recommendationText = document.getElementById('recommendationText');
            recommendationText.textContent = data.recommendation;
            
            const recommendationCard = document.getElementById('recommendationCard');
            const recommendationHeader = recommendationCard.querySelector('.card-header');
            
            if (data.recommendation.includes('ПОКУПАТЬ')) {
                recommendationHeader.className = 'card-header bg-success text-white';
            } else {
                recommendationHeader.className = 'card-header bg-danger text-white';
            }
            
            // Отображение уровня уверенности
            if (data.confidence_level !== undefined) {
                const confidenceBar = document.getElementById('confidenceBar');
                confidenceBar.style.width = data.confidence_level + '%';
                confidenceBar.textContent = data.confidence_level + '% уверенности';
                
                if (data.confidence_level >= 70) {
                    confidenceBar.style.backgroundColor = '#28a745';
                } else if (data.confidence_level >= 40) {
                    confidenceBar.style.backgroundColor = '#ffc107';
                } else {
                    confidenceBar.style.backgroundColor = '#dc3545';
                }
            }
            
            // Отображение причин рекомендации
            const reasonsList = document.getElementById('reasonsList');
            reasonsList.innerHTML = '';
            
            if (data.reasons && data.reasons.length > 0) {
                data.reasons.forEach(reason => {
                    const reasonItem = document.createElement('div');
                    reasonItem.className = 'list-group-item';
                    reasonItem.innerHTML = reason;
                    reasonsList.appendChild(reasonItem);
                });
            }
            
            // Отображение цен входа/выхода
            if (data.entry_exit_prices) {
                document.getElementById('entryPriceBuy').textContent = data.entry_exit_prices.entry_price_buy.toFixed(2);
                document.getElementById('exitPriceBuy').textContent = data.entry_exit_prices.exit_price_buy.toFixed(2);
                document.getElementById('stopLossBuy').textContent = data.entry_exit_prices.stop_loss_buy.toFixed(2);
                
                document.getElementById('entryPriceSell').textContent = data.entry_exit_prices.entry_price_sell.toFixed(2);
                document.getElementById('exitPriceSell').textContent = data.entry_exit_prices.exit_price_sell.toFixed(2);
                document.getElementById('stopLossSell').textContent = data.entry_exit_prices.stop_loss_sell.toFixed(2);
            }
            
            // Отображение прогнозов
            if (data.predictions) {
                ['15', '30', '60'].forEach(interval => {
                    if (data.predictions[interval]) {
                        const price = data.predictions[interval].price;
                        const change = data.predictions[interval].change;
                        
                        document.getElementById(`prediction${interval}`).textContent = price.toFixed(2) + ' ₽';
                        
                        const changeElement = document.getElementById(`change${interval}`);
                        const changeText = change.toFixed(2) + '%';
                        
                        if (change >= 0) {
                            changeElement.innerHTML = `<span class="price-change-positive">+${changeText} <i class="fas fa-arrow-up"></i></span>`;
                        } else {
                            changeElement.innerHTML = `<span class="price-change-negative">${changeText} <i class="fas fa-arrow-down"></i></span>`;
                        }
                    }
                });
            }

            // Отображение информации о метаобучении
            const metaLearningSection = document.getElementById('metaLearningSection');
            if (data.meta_learning && data.meta_learning.applied) {
                metaLearningSection.style.display = 'block';
                
                const metaLearningDetails = document.getElementById('metaLearningDetails');
                metaLearningDetails.innerHTML = '';
                
                if (data.meta_learning.intervals) {
                    let detailsHtml = '<ul class="list-group list-group-flush">';
                    
                    for (const [interval, details] of Object.entries(data.meta_learning.intervals)) {
                        if (details.applied) {
                            detailsHtml += `<li class="list-group-item">
                                <strong>Интервал ${interval} мин:</strong> Корректировка ${details.adjustment_pct > 0 ? '+' : ''}${details.adjustment_pct.toFixed(2)}%
                                <div><small>Исходная цена: ${details.original_price.toFixed(2)} ₽ → Скорректированная: ${details.corrected_price.toFixed(2)} ₽</small></div>`;
                            
                            if (details.adjustment_reasons && details.adjustment_reasons.length > 0) {
                                detailsHtml += '<div><small>Причины корректировки:</small></div><ul>';
                                details.adjustment_reasons.forEach(reason => {
                                    detailsHtml += `<li><small>${reason.description}</small></li>`;
                                });
                                detailsHtml += '</ul>';
                            }
                            
                            detailsHtml += '</li>';
                        }
                    }
                    
                    detailsHtml += '</ul>';
                    metaLearningDetails.innerHTML = detailsHtml;
                }
                
                // Отображение графика метаобучения
                if (data.meta_learning.chart_path) {
                    const metaLearningChart = document.getElementById('metaLearningChart');
                    metaLearningChart.innerHTML = `<img src="${data.meta_learning.chart_path}?t=${Date.now()}" class="img-fluid" alt="График метаобучения">`;
                }
            } else {
                metaLearningSection.style.display = 'none';
            }

            // Отображение информации о динамическом взвешивании ансамбля
            const ensembleWeightsSection = document.getElementById('ensembleWeightsSection');
            if (data.advanced_models && data.advanced_models.ensemble_weights) {
                ensembleWeightsSection.style.display = 'block';
                
                const weightsContainer = document.getElementById('weightsContainer');
                weightsContainer.innerHTML = '';
                
                const weights = data.advanced_models.ensemble_weights;
                
                for (const [model, weight] of Object.entries(weights)) {
                    const modelName = model === 'lstm' ? 'LSTM (нейросеть)' : model === 'arima' ? 'ARIMA (статистика)' : model;
                    
                    const weightElement = document.createElement('div');
                    weightElement.className = 'col-md-6 mb-3';
                    weightElement.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h6>${modelName}</h6>
                                <div class="weight-progress">
                                    <div class="weight-bar" style="width: ${weight*100}%"></div>
                                    <div class="weight-text">${(weight*100).toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    weightsContainer.appendChild(weightElement);
                }
                
                // Отображение графика ансамбля моделей
                if (data.advanced_models.chart_path) {
                    const ensembleChart = document.getElementById('ensembleChart');
                    ensembleChart.innerHTML = `<img src="${data.advanced_models.chart_path}?t=${Date.now()}" class="img-fluid" alt="График ансамбля моделей">`;
                }
            } else {
                ensembleWeightsSection.style.display = 'none';
            }
            
            // Отображение графика прогноза
            document.getElementById('predictionChart').src = data.chart_path + '?t=' + Date.now();

            // Сброс авто-обновления
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
                autoUpdateInterval = null;
                const updateBtn = document.getElementById('update-data-btn');
                updateBtn.textContent = 'Автообновление';
                updateBtn.classList.remove('btn-outline-danger');
                updateBtn.classList.add('btn-outline-primary');
            }
        }

        document.getElementById('update-data-btn').addEventListener('click', function() {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
                autoUpdateInterval = null;
                this.textContent = 'Автообновление';
                this.classList.remove('btn-outline-danger');
                this.classList.add('btn-outline-primary');
            } else {
                if (currentTicker) {
                    this.textContent = 'Остановить обновление';
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-outline-danger');
                    
                    updateData();
                    autoUpdateInterval = setInterval(updateData, 60000); // Обновление каждую минуту
                }
            }
        });

        function updateData() {
            if (!currentTicker) return;
            
            const formData = new FormData();
            formData.append('ticker', currentTicker);
            
            fetch('/auto_update', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Ошибка обновления:', data.error);
                    return;
                }
                
                // Обновление только необходимых элементов
                document.getElementById('currentPrice').textContent = data.current_price.toFixed(2);
                document.getElementById('predictionChart').src = data.chart_path;
                
                const priceChangeEl = document.getElementById('priceChange');
                const priceChangeText = data.price_change.toFixed(2) + '%';
                if (data.price_change >= 0) {
                    priceChangeEl.innerHTML = `<span class="price-change-positive">+${priceChangeText} <i class="fas fa-arrow-up"></i></span>`;
                } else {
                    priceChangeEl.innerHTML = `<span class="price-change-negative">${priceChangeText} <i class="fas fa-arrow-down"></i></span>`;
                }
                
                document.getElementById('rsi').textContent = data.rsi.toFixed(2);
                document.getElementById('macd').textContent = data.macd.toFixed(4);
                document.getElementById('signalLine').textContent = data.signal_line.toFixed(4);
                
                // Обновление прогнозов
                if (data.predictions) {
                    ['15', '30', '60'].forEach(interval => {
                        if (data.predictions[interval]) {
                            const price = data.predictions[interval].price;
                            const change = data.predictions[interval].change;
                            
                            document.getElementById(`prediction${interval}`).textContent = price.toFixed(2) + ' ₽';
                            
                            const changeElement = document.getElementById(`change${interval}`);
                            const changeText = change.toFixed(2) + '%';
                            
                            if (change >= 0) {
                                changeElement.innerHTML = `<span class="price-change-positive">+${changeText} <i class="fas fa-arrow-up"></i></span>`;
                            } else {
                                changeElement.innerHTML = `<span class="price-change-negative">${changeText} <i class="fas fa-arrow-down"></i></span>`;
                            }
                        }
                    });
                }
                
                document.getElementById('recommendationText').textContent = data.recommendation;
                
                const recommendationCard = document.getElementById('recommendationCard');
                const recommendationHeader = recommendationCard.querySelector('.card-header');
                
                if (data.recommendation.includes('ПОКУПАТЬ')) {
                    recommendationHeader.className = 'card-header bg-success text-white';
                } else {
                    recommendationHeader.className = 'card-header bg-danger text-white';
                }
                
                const momentumEl = document.getElementById('momentum');
                const momentumText = data.momentum.toFixed(2);
                if (data.momentum >= 0) {
                    momentumEl.innerHTML = `<span class="price-change-positive">+${momentumText} <i class="fas fa-arrow-up"></i></span>`;
                } else {
                    momentumEl.innerHTML = `<span class="price-change-negative">${momentumText} <i class="fas fa-arrow-down"></i></span>`;
                }
            })
            .catch(error => {
                console.error('Ошибка при автообновлении:', error);
            });
        }

        document.getElementById('accuracyBtn').addEventListener('click', function() {
            const accuracySection = document.getElementById('accuracySection');
            
            if (accuracySection.style.display === 'none') {
                accuracySection.style.display = 'block';
                this.textContent = 'Скрыть';
                
                if (currentTicker) {
                    const accuracyLoading = document.getElementById('accuracyLoading');
                    const accuracyContent = document.getElementById('accuracyContent');
                    
                    accuracyLoading.style.display = 'block';
                    accuracyContent.innerHTML = '';
                    
                    fetch(`/prediction_accuracy/${currentTicker}`)
                        .then(response => response.json())
                        .then(data => {
                            accuracyLoading.style.display = 'none';
                            
                            if (data.error) {
                                accuracyContent.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                                return;
                            }
                            
                            let html = '';
                            
                            // Проверка, какой тип данных мы получили
                            if (data.market_factors || data.error_patterns) {
                                // Новый формат данных от evaluate_prediction_quality
                                html += '<h5 class="mb-3">Результаты обучения на основе предыдущих прогнозов</h5>';
                                
                                if (data.learning_curve_chart) {
                                    html += `<div class="mb-4">
                                        <img src="${data.learning_curve_chart}?t=${Date.now()}" class="img-fluid" alt="Кривая обучения">
                                    </div>`;
                                }
                                
                                if (data.market_factors) {
                                    html += '<div class="mb-4"><h6>Рыночные факторы и их влияние:</h6><ul class="list-group">';
                                    
                                    for (const [interval, factors] of Object.entries(data.market_factors)) {
                                        html += `<li class="list-group-item">
                                            <strong>Интервал ${interval} мин:</strong>
                                            <div>Корреляция размера прогноза с ошибкой: ${factors.prediction_error_correlation}</div>
                                            <div>${factors.interpretation}</div>
                                        </li>`;
                                    }
                                    
                                    html += '</ul></div>';
                                }
                                
                                if (data.error_patterns) {
                                    html += '<div class="mb-4"><h6>Паттерны ошибок:</h6><ul class="list-group">';
                                    
                                    for (const [interval, patterns] of Object.entries(data.error_patterns)) {
                                        html += `<li class="list-group-item">
                                            <strong>Интервал ${interval} мин:</strong>
                                            <div>Тип смещения: ${patterns.bias_type} (${patterns.bias_ratio}%)</div>`;
                                        
                                        if (patterns.largest_errors && patterns.largest_errors.length > 0) {
                                            html += '<div><small>Наибольшие ошибки:</small><ul>';
                                            patterns.largest_errors.forEach(err => {
                                                html += `<li><small>Ошибка: ${err.error_pct}%, прогноз: ${err.predicted_change}%, факт: ${err.actual_change}%</small></li>`;
                                            });
                                            html += '</ul></div>';
                                        }
                                        
                                        html += '</li>';
                                    }
                                    
                                    html += '</ul></div>';
                                }
                                
                                if (data.improvement_factors && data.improvement_factors.length > 0) {
                                    html += '<div class="mb-4"><h6>Факторы для улучшения:</h6><ul class="list-group">';
                                    
                                    data.improvement_factors.forEach(factor => {
                                        html += `<li class="list-group-item">
                                            <strong>${factor.factor}:</strong> Влияние: ${factor.impact}%
                                            <div>${factor.recommendation}</div>
                                        </li>`;
                                    });
                                    
                                    html += '</ul></div>';
                                }
                                
                                if (data.model_adjustments) {
                                    html += '<div class="mb-4"><h6>Предлагаемые корректировки модели:</h6><ul class="list-group">';
                                    
                                    for (const [interval, adjustment] of Object.entries(data.model_adjustments)) {
                                        html += `<li class="list-group-item">
                                            <strong>Интервал ${interval} мин:</strong>
                                            <div>Коэффициент корректировки: ${adjustment.adjustment_factor}</div>
                                            <div>${adjustment.explanation}</div>
                                        </li>`;
                                    }
                                    
                                    html += '</ul></div>';
                                }
                                
                                if (data.meta_learning && data.meta_learning.consistent_bias) {
                                    html += `<div class="alert alert-info">
                                        <strong>Системное обучение:</strong> ${data.meta_learning.consistent_bias.recommendation}
                                        <div>Глобальный коэффициент корректировки: ${data.meta_learning.consistent_bias.global_adjustment_factor}</div>
                                    </div>`;
                                }
                                
                                if (data.meta_learning && data.meta_learning.interval_performance) {
                                    html += `<div class="alert alert-success">
                                        <strong>Производительность по интервалам:</strong> ${data.meta_learning.interval_performance.recommendation}
                                        <div>Лучший интервал: ${data.meta_learning.interval_performance.best_interval} мин (точность: ${data.meta_learning.interval_performance.accuracy}%)</div>
                                    </div>`;
                                }
                            } else {
                                // Старый формат данных от calculate_advanced_metrics
                                html += '<h5 class="mb-3">Точность предыдущих прогнозов</h5>';
                                
                                for (const [interval, metrics] of Object.entries(data)) {
                                    if (typeof metrics === 'object' && !metrics.error) {
                                        html += `
                                            <div class="card mb-3">
                                                <div class="card-header bg-primary text-white">
                                                    Интервал ${interval} мин
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <p><strong>RMSE:</strong> ${metrics.rmse}</p>
                                                            <p><strong>MAE:</strong> ${metrics.mae}</p>
                                                            <p><strong>MAPE:</strong> ${metrics.mape}%</p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <p><strong>Точность направления:</strong> ${metrics.direction_accuracy}%</p>
                                                            <p><strong>Количество прогнозов:</strong> ${metrics.samples}</p>
                                                        </div>
                                                    </div>
                                                    ${metrics.error_distribution_chart ? 
                                                        `<div class="mt-3">
                                                            <img src="${metrics.error_distribution_chart}?t=${Date.now()}" class="img-fluid" alt="Распределение ошибок">
                                                        </div>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }
                                }
                            }
                            
                            if (html === '') {
                                accuracyContent.innerHTML = '<div class="alert alert-info">Недостаточно данных для анализа точности прогнозов.</div>';
                            } else {
                                accuracyContent.innerHTML = html;
                            }
                        })
                        .catch(error => {
                            accuracyLoading.style.display = 'none';
                            accuracyContent.innerHTML = `<div class="alert alert-danger">Ошибка при загрузке данных о точности: ${error.message}</div>`;
                        });
                }
                
            } else {
                accuracySection.style.display = 'none';
                this.textContent = 'Показать';
            }
        });

        document.getElementById('advancedAnalyticsBtn').addEventListener('click', function() {
            const advancedSection = document.getElementById('advancedAnalyticsSection');
            
            if (advancedSection.style.display === 'none') {
                advancedSection.style.display = 'block';
                this.textContent = 'Скрыть расширенный анализ';
                
                if (currentTicker) {
                    const advancedLoading = document.getElementById('advancedLoading');
                    const advancedContent = document.getElementById('advancedContent');
                    
                    advancedLoading.style.display = 'block';
                    advancedContent.innerHTML = '';
                    
                    fetch(`/advanced_analytics/${currentTicker}`)
                        .then(response => response.json())
                        .then(data => {
                            advancedLoading.style.display = 'none';
                            
                            if (data.error) {
                                advancedContent.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                                return;
                            }
                            
                            let html = '';
                            
                            // Вывод результатов кросс-валидации
                            if (data.cross_validation) {
                                html += `
                                    <div class="card mb-4">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">Кросс-валидация моделей</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <p><strong>Лучшая модель:</strong> ${data.cross_validation.best_model}</p>
                                                </div>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-bordered table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Модель</th>
                                                            <th>RMSE</th>
                                                            <th>MAE</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                `;
                                
                                for (const [model, metrics] of Object.entries(data.cross_validation.models)) {
                                    html += `
                                        <tr>
                                            <td>${model}</td>
                                            <td>${metrics.avg_rmse}</td>
                                            <td>${metrics.avg_mae}</td>
                                        </tr>
                                    `;
                                }
                                
                                html += `
                                                    </tbody>
                                                </table>
                                            </div>
                                            ${data.cross_validation.chart_path ? 
                                                `<div class="mt-3">
                                                    <img src="${data.cross_validation.chart_path}?t=${Date.now()}" class="img-fluid" alt="Результаты кросс-валидации">
                                                </div>` : ''}
                                        </div>
                                    </div>
                                `;
                            }
                            
                            // Вывод результатов оптимизации гиперпараметров
                            if (data.hyperparameters) {
                                html += `
                                    <div class="card mb-4">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="mb-0">Оптимальные гиперпараметры</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <p><strong>Лучшая RMSE:</strong> ${data.hyperparameters.best_rmse}</p>
                                                    <p><strong>Лучшие параметры:</strong></p>
                                                    <ul>
                                                        <li>n_estimators: ${data.hyperparameters.best_params.n_estimators}</li>
                                                        <li>learning_rate: ${data.hyperparameters.best_params.learning_rate}</li>
                                                        <li>max_depth: ${data.hyperparameters.best_params.max_depth}</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            ${data.hyperparameters.chart_path ? 
                                                `<div class="mt-3">
                                                    <img src="${data.hyperparameters.chart_path}?t=${Date.now()}" class="img-fluid" alt="Оптимальные гиперпараметры">
                                                </div>` : ''}
                                        </div>
                                    </div>
                                `;
                            }
                            
                            // Вывод результатов продвинутых моделей
                            if (data.advanced_models && !data.advanced_models_error) {
                                html += `
                                    <div class="card mb-4">
                                        <div class="card-header bg-info text-white">
                                            <h5 class="mb-0">Расширенные модели прогнозирования</h5>
                                        </div>
                                        <div class="card-body">
                                `;
                                
                                if (data.advanced_models.models_used) {
                                    html += `<p><strong>Используемые модели:</strong> ${data.advanced_models.models_used.join(', ')}</p>`;
                                }
                                
                                if (data.advanced_models.ensemble_weights) {
                                    html += `<div class="mb-3"><strong>Веса ансамбля:</strong><ul>`;
                                    
                                    for (const [model, weight] of Object.entries(data.advanced_models.ensemble_weights)) {
                                        html += `<li>${model}: ${(weight*100).toFixed(1)}%</li>`;
                                    }
                                    
                                    html += `</ul></div>`;
                                }
                                
                                if (data.advanced_models.weight_method) {
                                    html += `<p><strong>Метод определения весов:</strong> ${data.advanced_models.weight_method}</p>`;
                                }
                                
                                if (data.advanced_models.predictions) {
                                    html += `
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Интервал (мин)</th>
                                                        <th>Цена</th>
                                                        <th>Изменение</th>
                                                        <th>Модель</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                    `;
                                    
                                    for (const [interval, prediction] of Object.entries(data.advanced_models.predictions)) {
                                        html += `
                                            <tr>
                                                <td>${interval}</td>
                                                <td>${prediction.price.toFixed(2)} ₽</td>
                                                <td class="${prediction.change >= 0 ? 'price-change-positive' : 'price-change-negative'}">
                                                    ${prediction.change >= 0 ? '+' : ''}${prediction.change.toFixed(2)}%
                                                </td>
                                                <td>${prediction.model_type || 'Ансамбль'}</td>
                                            </tr>
                                        `;
                                    }
                                    
                                    html += `
                                                </tbody>
                                            </table>
                                        </div>
                                    `;
                                }
                                
                                if (data.advanced_models.chart_path) {
                                    html += `
                                        <div class="mt-3">
                                            <img src="${data.advanced_models.chart_path}?t=${Date.now()}" class="img-fluid" alt="Расширенные модели прогнозирования">
                                        </div>
                                    `;
                                }
                                
                                html += `
                                        </div>
                                    </div>
                                `;
                            } else if (data.advanced_models_error) {
                                html += `<div class="alert alert-warning">Ошибка при создании расширенных моделей: ${data.advanced_models_error}</div>`;
                            }
                            
                            advancedContent.innerHTML = html;
                        })
                        .catch(error => {
                            advancedLoading.style.display = 'none';
                            advancedContent.innerHTML = `<div class="alert alert-danger">Ошибка при загрузке расширенной аналитики: ${error.message}</div>`;
                        });
                }
                
            } else {
                advancedSection.style.display = 'none';
                this.textContent = 'Расширенный анализ';
            }
        });
    </script>
</body>
</html>
