
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ акций Тинькофф</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            background-color: #f7f9fc;
        }
        .card {
            margin-bottom: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #e9effd;
            border-bottom: 1px solid #d1e1fd;
        }
        .analysis-container {
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .chart-container {
            text-align: center;
            margin: 1rem 0;
        }
        .chart-img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .key-value {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .recommendation-box {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .buy {
            background-color: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.4);
            color: #155724;
        }
        .sell {
            background-color: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.4);
            color: #721c24;
        }
        .market-state-item {
            background-color: #f8f9fa;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .price-info {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 5px;
        }
        .error-message {
            color: #dc3545;
            padding: 10px;
            display: none;
            border-radius: 5px;
            background-color: rgba(220, 53, 69, 0.1);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">PrismTrade - Анализ тренда акций</h1>
        
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Введите тикер акции</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="ticker-input" class="form-label">Тикер</label>
                            <input type="text" class="form-control" id="ticker-input" placeholder="Например: SBER">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" id="analyze-btn">Анализировать</button>
                        </div>
                    </div>
                </div>
                <div class="error-message" id="error-message"></div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-2">Анализируем данные...</p>
        </div>
        
        <div class="analysis-container" id="analysis-container">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Результаты анализа: <span id="ticker-title"></span></h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="price-info">Текущая цена: <span id="current-price"></span> ₽</div>
                            <div class="mb-3">
                                <div class="key-value">
                                    <span>Изменение цены:</span>
                                    <span id="price-change"></span>
                                </div>
                                <div class="key-value">
                                    <span>Волатильность:</span>
                                    <span id="volatility"></span>
                                </div>
                                <div class="key-value">
                                    <span>RSI:</span>
                                    <span id="rsi-value"></span>
                                </div>
                                <div class="key-value">
                                    <span>MA5:</span>
                                    <span id="ma5-value"></span>
                                </div>
                                <div class="key-value">
                                    <span>MA20:</span>
                                    <span id="ma20-value"></span>
                                </div>
                                <div class="key-value">
                                    <span>Тренд по MA:</span>
                                    <span id="trend-value"></span>
                                </div>
                                <div class="key-value">
                                    <span>Моментум:</span>
                                    <span id="momentum-value"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="recommendation-box" id="recommendation-box"></div>
                            <div class="key-value">
                                <span>Прогноз (15 мин):</span>
                                <span id="prediction-15"></span>
                            </div>
                            <div class="key-value">
                                <span>Прогноз (30 мин):</span>
                                <span id="prediction-30"></span>
                            </div>
                            <div class="key-value">
                                <span>Прогноз (60 мин):</span>
                                <span id="prediction-60"></span>
                            </div>
                            <div class="key-value">
                                <span>Уровень уверенности:</span>
                                <span id="confidence-level"></span>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="chart-container">
                        <img id="chart-img" class="chart-img" alt="График прогноза">
                    </div>
                    
                    <div class="mt-3">
                        <h5>Состояние рынка</h5>
                        <div id="market-state-container">
                            <!-- Market state items will be added here -->
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mt-3">
                        <h5>Точки входа/выхода</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-success bg-opacity-25">
                                        <h6 class="card-title mb-0">Покупка (ЛОНГ)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="key-value">
                                            <span>Точка входа:</span>
                                            <span id="entry-buy"></span>
                                        </div>
                                        <div class="key-value">
                                            <span>Цель:</span>
                                            <span id="exit-buy"></span>
                                        </div>
                                        <div class="key-value">
                                            <span>Стоп-лосс:</span>
                                            <span id="stop-loss-buy"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-danger bg-opacity-25">
                                        <h6 class="card-title mb-0">Продажа (ШОРТ)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="key-value">
                                            <span>Точка входа:</span>
                                            <span id="entry-sell"></span>
                                        </div>
                                        <div class="key-value">
                                            <span>Цель:</span>
                                            <span id="exit-sell"></span>
                                        </div>
                                        <div class="key-value">
                                            <span>Стоп-лосс:</span>
                                            <span id="stop-loss-sell"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Факторы, влияющие на решение</h5>
                        <ul class="list-group" id="reasons-list">
                            <!-- Reasons will be added here -->
                        </ul>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button class="btn btn-outline-primary" id="update-data-btn" onclick="startAutoUpdate()">Обновить данные</button>
                    </div>
                </div>
            </div>
            
            <div id="chart-container" class="mt-4">
                <img src="" id="auto-update-btn">Обновить данные</button>
                        <button class="btn btn-outline-info ms-2" id="view-accuracy-btn">Точность прогнозов</button>
                        <button class="btn btn-outline-secondary ms-2" id="advanced-analytics-btn">Расширенная аналитика</button>
                    </div>
                </div>
            </div>
            
            <div id="accuracy-container" style="display: none">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Историческая точность прогнозов</h5>
                    </div>
                    <div class="card-body" id="accuracy-content">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <p class="mt-2">Анализируем историю прогнозов...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="advanced-analytics-container" style="display: none">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Расширенная аналитика моделей</h5>
                    </div>
                    <div class="card-body" id="advanced-analytics-content">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <p class="mt-2">Проводим расширенный анализ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const analyzeBtn = document.getElementById('analyze-btn');
            const tickerInput = document.getElementById('ticker-input');
            const loadingDiv = document.getElementById('loading');
            const analysisContainer = document.getElementById('analysis-container');
            const tickerTitle = document.getElementById('ticker-title');
            const currentPrice = document.getElementById('current-price');
            const priceChange = document.getElementById('price-change');
            const volatilityElem = document.getElementById('volatility');
            const rsiValue = document.getElementById('rsi-value');
            const ma5Value = document.getElementById('ma5-value');
            const ma20Value = document.getElementById('ma20-value');
            const trendValue = document.getElementById('trend-value');
            const momentumValue = document.getElementById('momentum-value');
            const recommendationBox = document.getElementById('recommendation-box');
            const prediction15 = document.getElementById('prediction-15');
            const prediction30 = document.getElementById('prediction-30');
            const prediction60 = document.getElementById('prediction-60');
            const confidenceLevel = document.getElementById('confidence-level');
            const chartImg = document.getElementById('chart-img');
            const reasonsList = document.getElementById('reasons-list');
            const entryBuy = document.getElementById('entry-buy');
            const exitBuy = document.getElementById('exit-buy');
            const stopLossBuy = document.getElementById('stop-loss-buy');
            const entrySell = document.getElementById('entry-sell');
            const exitSell = document.getElementById('exit-sell');
            const stopLossSell = document.getElementById('stop-loss-sell');
            const errorMessage = document.getElementById('error-message');
            const marketStateContainer = document.getElementById('market-state-container');
            const autoUpdateBtn = document.getElementById('auto-update-btn');
            const viewAccuracyBtn = document.getElementById('view-accuracy-btn');
            const accuracyContainer = document.getElementById('accuracy-container');
            const accuracyContent = document.getElementById('accuracy-content');
            const advancedAnalyticsBtn = document.getElementById('advanced-analytics-btn');
            const advancedAnalyticsContainer = document.getElementById('advanced-analytics-container');
            const advancedAnalyticsContent = document.getElementById('advanced-analytics-content');

            let currentTicker = '';
            
            analyzeBtn.addEventListener('click', function() {
                currentTicker = tickerInput.value.trim().toUpperCase();
                if (!currentTicker) {
                    showError('Пожалуйста, введите тикер акции');
                    return;
                }
                
                analyzeStock(currentTicker);
            });
            
            tickerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    analyzeBtn.click();
                }
            });
            
            autoUpdateBtn.addEventListener('click', function() {
                if (currentTicker) {
                    autoUpdateData(currentTicker);
                }
            });
            
            viewAccuracyBtn.addEventListener('click', function() {
                if (currentTicker) {
                    toggleAccuracyView();
                    loadAccuracyData(currentTicker);
                }
            });
            
            advancedAnalyticsBtn.addEventListener('click', function() {
                if (currentTicker) {
                    toggleAdvancedAnalyticsView();
                    loadAdvancedAnalytics(currentTicker);
                }
            });
            
            let autoUpdateInterval = null;
            
            function startAutoUpdate() {
                const ticker = document.getElementById('ticker-input').value.trim().toUpperCase();
                if (!ticker) {
                    showError('Пожалуйста, введите тикер акции');
                    return;
                }
                
                if (autoUpdateInterval) {
                    clearInterval(autoUpdateInterval);
                }
                
                // Обновить сразу
                updateData(ticker);
                
                // Затем обновлять каждую минуту
                autoUpdateInterval = setInterval(() => {
                    if (currentTicker) {
                        updateData(currentTicker);
                    }
                }, 60000); // 60000 мс = 1 минута
                
                // Изменить текст кнопки
                const updateBtn = document.getElementById('update-data-btn');
                if (updateBtn) {
                    updateBtn.textContent = 'Остановить обновление';
                    updateBtn.classList.remove('btn-outline-primary');
                    updateBtn.classList.add('btn-outline-danger');
                    updateBtn.onclick = stopAutoUpdate;
                }
            }
            
            function stopAutoUpdate() {
                if (autoUpdateInterval) {
                    clearInterval(autoUpdateInterval);
                    autoUpdateInterval = null;
                }
                
                // Вернуть прежний текст кнопки
                const updateBtn = document.getElementById('update-data-btn');
                if (updateBtn) {
                    updateBtn.textContent = 'Обновить данные';
                    updateBtn.classList.remove('btn-outline-danger');
                    updateBtn.classList.add('btn-outline-primary');
                    updateBtn.onclick = function() {
                        startAutoUpdate();
                    };
                }
            }
            
            function toggleAccuracyView() {
                if (accuracyContainer.style.display === 'none' || !accuracyContainer.style.display) {
                    accuracyContainer.style.display = 'block';
                    advancedAnalyticsContainer.style.display = 'none';
                } else {
                    accuracyContainer.style.display = 'none';
                }
            }
            
            function toggleAdvancedAnalyticsView() {
                if (advancedAnalyticsContainer.style.display === 'none' || !advancedAnalyticsContainer.style.display) {
                    advancedAnalyticsContainer.style.display = 'block';
                    accuracyContainer.style.display = 'none';
                } else {
                    advancedAnalyticsContainer.style.display = 'none';
                }
            }
            
            function updateData(ticker) {
                const formData = new FormData();
                formData.append('ticker', ticker);
                
                // Обновить статус без полной перезагрузки
                const statusDiv = document.createElement('div');
                statusDiv.className = 'update-status';
                statusDiv.innerHTML = `<small class="text-muted">Обновление данных: ${new Date().toLocaleTimeString()}</small>`;
                const chartContainer = document.getElementById('chart-container');
                if (chartContainer) {
                    chartContainer.appendChild(statusDiv);
                }
                
                fetch('/auto_update', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        if (statusDiv.parentNode) {
                            statusDiv.parentNode.removeChild(statusDiv);
                        }
                        return;
                    }
                    
                    // Обновляем текущую цену и основные индикаторы
                    const currentPriceEl = document.getElementById('current-price');
                    if (currentPriceEl) currentPriceEl.textContent = `${data.current_price.toFixed(2)} ₽`;
                    
                    const rsiEl = document.getElementById('rsi-value');
                    if (rsiEl && data.rsi !== undefined) rsiEl.textContent = data.rsi.toFixed(2);
                    
                    const priceChangeEl = document.getElementById('price-change');
                    if (priceChangeEl && data.price_change !== undefined) {
                        const priceChangeValue = data.price_change.toFixed(2);
                        const priceChangeClass = priceChangeValue > 0 ? 'text-success' : (priceChangeValue < 0 ? 'text-danger' : 'text-muted');
                        priceChangeEl.innerHTML = `<span class="${priceChangeClass}">${priceChangeValue}%</span>`;
                    }
                    
                    const recommendationBox = document.getElementById('recommendation-box');
                    if (recommendationBox && data.recommendation) {
                        recommendationBox.textContent = data.recommendation;
                        recommendationBox.className = 'recommendation-box';
                        if (data.recommendation.includes('ПОКУПАТЬ')) {
                            recommendationBox.classList.add('buy');
                        } else if (data.recommendation.includes('ПРОДАВАТЬ')) {
                            recommendationBox.classList.add('sell');
                        }
                    }
                    
                    // Обновляем прогнозы
                    for (const interval in data.predictions) {
                        const predEl = document.getElementById(`prediction-${interval}`);
                        if (predEl) {
                            predEl.innerHTML = formatPrediction(data.predictions[interval]);
                        }
                    }
                    
                    // Обновляем график с добавлением временной метки для предотвращения кэширования
                    const chartImg = document.getElementById('chart-img');
                    if (chartImg) {
                        chartImg.src = `${data.chart_path}?t=${Date.now()}`;
                    }
                    
                    // Удаляем статус обновления через 3 секунды
                    setTimeout(() => {
                        if (statusDiv.parentNode) {
                            statusDiv.parentNode.removeChild(statusDiv);
                        }
                    }, 3000);
                })
                .catch(error => {
                    console.error('Ошибка при обновлении данных:', error);
                    showError('Ошибка при обновлении данных');
                    
                    if (statusDiv.parentNode) {
                        statusDiv.parentNode.removeChild(statusDiv);
                    }
                });
            }
            
            function analyzeStock(ticker) {
                showLoading();
                hideError();
                
                // Останавливаем автообновление, если оно работало
                stopAutoUpdate();
                
                const formData = new FormData();
                formData.append('ticker', ticker);
                
                fetch('/analyze', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    currentTicker = ticker;
                    displayAnalysis(data);
                })
                .catch(error => {
                    hideLoading();
                    showError('Произошла ошибка при обработке запроса: ' + error);
                });
            }
            
            function autoUpdateData(ticker) {
                const formData = new FormData();
                formData.append('ticker', ticker);
                
                fetch('/auto_update', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    updateChartAndStats(data);
                })
                .catch(error => {
                    showError('Произошла ошибка при обновлении данных: ' + error);
                });
            }
            
            function loadAccuracyData(ticker) {
                accuracyContent.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Анализируем историю прогнозов...</p>
                    </div>
                `;
                
                fetch(`/prediction_accuracy/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        accuracyContent.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                        return;
                    }
                    
                    displayAccuracyData(data);
                })
                .catch(error => {
                    accuracyContent.innerHTML = `<div class="alert alert-danger">Ошибка при загрузке данных о точности: ${error}</div>`;
                });
            }
            
            function loadAdvancedAnalytics(ticker) {
                advancedAnalyticsContent.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Проводим расширенный анализ...</p>
                    </div>
                `;
                
                fetch(`/advanced_analytics/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        advancedAnalyticsContent.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                        return;
                    }
                    
                    displayAdvancedAnalytics(data);
                })
                .catch(error => {
                    advancedAnalyticsContent.innerHTML = `<div class="alert alert-danger">Ошибка при загрузке расширенной аналитики: ${error}</div>`;
                });
            }
            
            function displayAccuracyData(data) {
                let html = '<h5 class="mb-3">Точность прогнозов по интервалам</h5>';
                html += '<div class="row">';
                
                const intervals = Object.keys(data);
                
                intervals.forEach(interval => {
                    const intervalData = data[interval];
                    
                    html += `
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-header">Прогноз на ${interval} минут</div>
                                <div class="card-body">
                                    <div class="key-value">
                                        <span>Средняя ошибка:</span>
                                        <span>${intervalData.mape || intervalData.avg_error_pct || 'Н/Д'}%</span>
                                    </div>
                                    <div class="key-value">
                                        <span>Точность направления:</span>
                                        <span>${intervalData.direction_accuracy || 'Н/Д'}%</span>
                                    </div>
                                    <div class="key-value">
                                        <span>Количество прогнозов:</span>
                                        <span>${intervalData.samples || 'Н/Д'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (intervalData.error_distribution_chart) {
                        html += `
                            <div class="col-md-8 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">Распределение ошибок (${interval} мин)</div>
                                    <div class="card-body text-center">
                                        <img src="${intervalData.error_distribution_chart}" class="img-fluid" alt="Distribution chart">
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                
                accuracyContent.innerHTML = html;
            }
            
            function displayAdvancedAnalytics(data) {
                let html = '';
                
                if (data.cross_validation) {
                    const cvData = data.cross_validation;
                    
                    html += `
                        <div class="row mb-4">
                            <div class="col-md-5">
                                <h5>Результаты кросс-валидации</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <p><strong>Лучшая модель:</strong> ${cvData.best_model}</p>
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Модель</th>
                                                    <th>RMSE</th>
                                                    <th>MAE</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                    `;
                    
                    Object.entries(cvData.models).forEach(([model, scores]) => {
                        html += `
                            <tr>
                                <td>${model}</td>
                                <td>${scores.avg_rmse}</td>
                                <td>${scores.avg_mae}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <h5>Сравнение моделей</h5>
                                <div class="text-center">
                                    <img src="${cvData.chart_path}" class="img-fluid" alt="CV Results">
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (data.hyperparameters) {
                    const hpData = data.hyperparameters;
                    
                    html += `
                        <div class="row">
                            <div class="col-md-5">
                                <h5>Оптимальные гиперпараметры</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <p><strong>Лучшая RMSE:</strong> ${hpData.best_rmse}</p>
                                        <p><strong>Лучшие параметры:</strong></p>
                                        <ul>
                    `;
                    
                    Object.entries(hpData.best_params).forEach(([param, value]) => {
                        html += `<li>${param}: ${value}</li>`;
                    });
                    
                    html += `
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <h5>Влияние гиперпараметров</h5>
                                <div class="text-center">
                                    <img src="${hpData.chart_path}" class="img-fluid" alt="Hyperparameter Results">
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                advancedAnalyticsContent.innerHTML = html || '<div class="alert alert-info">Нет данных для расширенной аналитики</div>';
            }
            
            function displayAnalysis(data) {
                analysisContainer.style.display = 'block';
                
                tickerTitle.textContent = data.ticker;
                currentPrice.textContent = data.current_price.toFixed(2);
                
                const priceChangeValue = data.price_change.toFixed(2);
                const priceChangeClass = priceChangeValue > 0 ? 'text-success' : (priceChangeValue < 0 ? 'text-danger' : 'text-muted');
                priceChange.innerHTML = `<span class="${priceChangeClass}">${priceChangeValue}%</span>`;
                
                volatilityElem.textContent = data.volatility ? data.volatility.toFixed(2) + '%' : 'Н/Д';
                rsiValue.textContent = data.rsi ? data.rsi.toFixed(2) : 'Н/Д';
                ma5Value.textContent = data.ma5 ? data.ma5.toFixed(2) : 'Н/Д';
                ma20Value.textContent = data.ma20 ? data.ma20.toFixed(2) : 'Н/Д';
                
                trendValue.innerHTML = data.trend === 'ВОСХОДЯЩИЙ' 
                    ? '<span class="text-success">&#8593; ВОСХОДЯЩИЙ</span>' 
                    : '<span class="text-danger">&#8595; НИСХОДЯЩИЙ</span>';
                
                momentumValue.textContent = data.momentum ? data.momentum.toFixed(2) : 'Н/Д';
                
                recommendationBox.textContent = data.recommendation || 'Н/Д';
                recommendationBox.className = 'recommendation-box';
                if (data.recommendation && data.recommendation.includes('ПОКУПАТЬ')) {
                    recommendationBox.classList.add('buy');
                } else if (data.recommendation && data.recommendation.includes('ПРОДАВАТЬ')) {
                    recommendationBox.classList.add('sell');
                }
                
                if (data.predictions) {
                    prediction15.innerHTML = formatPrediction(data.predictions['15']);
                    prediction30.innerHTML = formatPrediction(data.predictions['30']);
                    prediction60.innerHTML = formatPrediction(data.predictions['60']);
                }
                
                if (data.confidence_level !== undefined) {
                    let confClass = 'text-warning';
                    if (data.confidence_level >= 70) confClass = 'text-success';
                    else if (data.confidence_level < 40) confClass = 'text-danger';
                    
                    confidenceLevel.innerHTML = `<span class="${confClass}">${data.confidence_level}%</span>`;
                }
                
                chartImg.src = data.chart_path + '?t=' + new Date().getTime();
                
                reasonsList.innerHTML = '';
                if (data.reasons && data.reasons.length) {
                    data.reasons.forEach(reason => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = reason;
                        reasonsList.appendChild(li);
                    });
                }
                
                if (data.entry_exit_prices) {
                    entryBuy.textContent = data.entry_exit_prices.entry_price_buy.toFixed(2) + ' ₽';
                    exitBuy.textContent = data.entry_exit_prices.exit_price_buy.toFixed(2) + ' ₽';
                    stopLossBuy.textContent = data.entry_exit_prices.stop_loss_buy.toFixed(2) + ' ₽';
                    
                    entrySell.textContent = data.entry_exit_prices.entry_price_sell.toFixed(2) + ' ₽';
                    exitSell.textContent = data.entry_exit_prices.exit_price_sell.toFixed(2) + ' ₽';
                    stopLossSell.textContent = data.entry_exit_prices.stop_loss_sell.toFixed(2) + ' ₽';
                }
                
                displayMarketState(data.market_state);
            }
            
            function displayMarketState(marketState) {
                marketStateContainer.innerHTML = '';
                
                if (!marketState) return;
                
                if (marketState.bullish) {
                    const bullishDiv = document.createElement('div');
                    bullishDiv.className = 'market-state-item';
                    bullishDiv.innerHTML = `⬆️ БЫЧИЙ ТРЕНД (сила: ${marketState.trend_strength}%)`;
                    marketStateContainer.appendChild(bullishDiv);
                } else if (marketState.bearish) {
                    const bearishDiv = document.createElement('div');
                    bearishDiv.className = 'market-state-item';
                    bearishDiv.innerHTML = `⬇️ МЕДВЕЖИЙ ТРЕНД (сила: ${marketState.trend_strength}%)`;
                    marketStateContainer.appendChild(bearishDiv);
                }
                
                if (marketState.correction) {
                    const correctionDiv = document.createElement('div');
                    correctionDiv.className = 'market-state-item';
                    correctionDiv.textContent = `Коррекция (глубина: ${marketState.correction_depth.toFixed(2)}%)`;
                    marketStateContainer.appendChild(correctionDiv);
                }
                
                if (marketState.explanation && marketState.explanation.length) {
                    marketState.explanation.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'market-state-item';
                        itemDiv.textContent = item;
                        marketStateContainer.appendChild(itemDiv);
                    });
                }
            }
            
            function updateChartAndStats(data) {
                currentPrice.textContent = data.current_price.toFixed(2);
                
                const priceChangeValue = data.price_change.toFixed(2);
                const priceChangeClass = priceChangeValue > 0 ? 'text-success' : (priceChangeValue < 0 ? 'text-danger' : 'text-muted');
                priceChange.innerHTML = `<span class="${priceChangeClass}">${priceChangeValue}%</span>`;
                
                rsiValue.textContent = data.rsi ? data.rsi.toFixed(2) : 'Н/Д';
                momentumValue.textContent = data.momentum ? data.momentum.toFixed(2) : 'Н/Д';
                
                recommendationBox.textContent = data.recommendation || 'Н/Д';
                recommendationBox.className = 'recommendation-box';
                if (data.recommendation && data.recommendation.includes('ПОКУПАТЬ')) {
                    recommendationBox.classList.add('buy');
                } else if (data.recommendation && data.recommendation.includes('ПРОДАВАТЬ')) {
                    recommendationBox.classList.add('sell');
                }
                
                if (data.predictions) {
                    prediction15.innerHTML = formatPrediction(data.predictions['15']);
                    prediction30.innerHTML = formatPrediction(data.predictions['30']);
                    prediction60.innerHTML = formatPrediction(data.predictions['60']);
                }
                
                chartImg.src = data.chart_path;
            }
            
            function formatPrediction(predData) {
                if (!predData) return 'Н/Д';
                
                const price = predData.price.toFixed(2);
                const change = predData.change.toFixed(2);
                const changeClass = change > 0 ? 'text-success' : (change < 0 ? 'text-danger' : 'text-muted');
                
                return `${price} ₽ <span class="${changeClass}">(${change}%)</span>`;
            }
            
            function showLoading() {
                loadingDiv.style.display = 'block';
                analysisContainer.style.display = 'none';
            }
            
            function hideLoading() {
                loadingDiv.style.display = 'none';
            }
            
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            
            function hideError() {
                errorMessage.style.display = 'none';
            }
        });
    </script>
</body>
</html>
<style>
    .update-status {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 5px 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
        z-index: 100;
    }

    #chart-container {
        position: relative;
    }
</style>
